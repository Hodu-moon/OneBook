<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="/templates/payment/css/style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>토스페이먼츠 샘플 프로젝트</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>

<body>
<!-- 주문서 영역 -->
<div class="wrapper">
    <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
        <!-- 결제 UI -->
        <div id="payment-method"></div>
        <!-- 이용약관 UI -->
        <div id="agreement"></div>

        <div class="checkable typography--p" style="margin-top:20px;">
            <label for="point-box" class="checkable__label typography--regular">
                <input id="point-box" class="checkable__input" type="checkbox" aria-checked="false" />
                <span class="checkable__label-text">포인트 사용하기</span>
            </label>
        </div>

        <div id="point-section" style="display:none; margin-left: 25px; margin-top: 10px;">
            <div>보유 포인트: <span id="user-point">0</span></div>
            <div style="margin-top: 5px;">
                <label for="usePointInput">사용할 포인트: </label>
                <input type="number" id="usePointInput" value="0" min="0" />
            </div>
        </div>

        <div class="result wrapper">
            <button class="button" id="payment-button" style="margin-top: 30px">
                결제하기
            </button>
        </div>
    </div>
</div>

<script>
    async function main() {
        // URL 파라미터에서 orderId 추출 예: /checkout?orderId=123
        const urlParams = new URLSearchParams(window.location.search);
        const orderIdParam = urlParams.get("orderId");

        // 1) TaskAPI에서 체크아웃 정보 GET
        let checkoutInfo = {};
        try {
            const res = await fetch(`/front/payments/checkout-info/${orderIdParam}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include" // JWT 쿠키 포함
            });
            if (!res.ok) {
                throw new Error("체크아웃 정보 조회 실패");
            }
            checkoutInfo = await res.json();
        } catch (error) {
            console.error(error);
            alert("결제 정보 불러오기 실패");
            return;
        }

        // 2) 결제위젯 초기화
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // 테스트용 키
        const tossPayments = TossPayments(clientKey);

        // (예) customerKey는 사용자 식별용 임의값
        // TODO 추후 멤버 id를 가져오는걸로 수정필요
        const customerKey = "662815698466120492";
        const widgets = tossPayments.widgets({ customerKey });

        // 결제금액
        let orderAmount = checkoutInfo.orderAmount || 0;
        await widgets.setAmount({ currency: "KRW", value: orderAmount });

        // 결제수단 UI
        await widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" });
        // 이용약관 UI
        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });

        // 3) 포인트 사용 로직
        const pointCheck = document.getElementById("point-box");
        const pointSection = document.getElementById("point-section");
        const userPointEl = document.getElementById("user-point");
        const usePointInput = document.getElementById("usePointInput");

        userPointEl.textContent = checkoutInfo.userPoint || 0;

        pointCheck.addEventListener("change", async () => {
            if (pointCheck.checked) {
                pointSection.style.display = "block";
                usePointInput.value = 0;
            } else {
                pointSection.style.display = "none";
                usePointInput.value = 0;
                // 포인트 사용 해제 -> 결제금액 복원
                await widgets.setAmount({ currency: "KRW", value: orderAmount });
            }
        });

        usePointInput.addEventListener("input", async () => {
            let inputVal = Number(usePointInput.value);
            const myPoint = Number(checkoutInfo.userPoint || 0);

            if (inputVal > myPoint) {
                inputVal = myPoint;
                usePointInput.value = myPoint;
            }
            const newAmount = orderAmount - inputVal;
            const finalAmount = newAmount < 0 ? 0 : newAmount;
            await widgets.setAmount({ currency: "KRW", value: finalAmount });
        });

        // 4) 결제하기 버튼
        document.getElementById("payment-button").addEventListener("click", async () => {
            const usedPoint = pointCheck.checked ? Number(usePointInput.value) : 0;

            // 5) 토스 결제위젯
            // TODO : 모든 정보를 taskapi DB에서 가져오도록 수정 필요
            await widgets.requestPayment({
                // orderId를 String으로 만들어야 중복 방지 + Long 파싱 오류 방지
                orderId: checkoutInfo.orderId + "_" + generateRandomString(),
                orderName: checkoutInfo.orderName || "주문 상품",
                successUrl: window.location.origin + "/success",
                failUrl: window.location.origin + "/fail",
                customerEmail: checkoutInfo.ordererEmail,
                customerName: checkoutInfo.ordererName ,
                // 특수문자 없이
                customerMobilePhone: "01011112222"
            });
        });
    }

    function generateRandomString() {
        // 중복 방지용.
        // orderId를 사용하지만, 만약 결제 취소 후, 재결제 시도시
        // 토스에서는 동일한 orderId가 또 들어오는걸 차단함
        // 그래서 orderId + 뒤에 임의의 랜덤 문자열을 생성함
        return Math.random().toString(36).substring(2,10);
    }

    main();
</script>
</body>
</html>
